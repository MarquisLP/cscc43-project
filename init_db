DROP DATABASE IF EXISTS MyBNB;
CREATE DATABASE MyBNB;
USE MyBNB;

CREATE TABLE Listing (
    ListingID CHAR(20)  NOT NULL,
    Type VARCHAR(100) NOT NULL,
    Latitude REAL NOT NULL,
    Longitude REAL NOT NULL,
    PRIMARY KEY (ListingID)
);

CREATE TABLE Availability (
    ListingID CHAR(20) NOT NULL,
    StartDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    EndDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    Price INT NOT NULL,
    PRIMARY KEY (ListingID, StartDate, EndDate),
    FOREIGN KEY (ListingID) REFERENCES Listing(ListingID) ON DELETE CASCADE
);

CREATE TABLE Amenities (
    ListingID CHAR(20),
    NumberOfGuests INT DEFAULT 1,
    Bathrooms REAL DEFAULT 0,
    Bedrooms INT DEFAULT 0,
    Beds INT DEFAULT 0,
    Kitchen INT DEFAULT 0,
    ParkingSpots INT DEFAULT 0,
    FOREIGN KEY (ListingID) REFERENCES  Listing(ListingID) ON DELETE CASCADE
);

CREATE TABLE Address (
    Country VARCHAR(20) NOT NULL,
    PostalCode VARCHAR(10) NOT NULL,
    City VARCHAR(30) NOT NULL,
    PRIMARY KEY (Country, PostalCode)
);

CREATE TABLE User (
    SIN VARCHAR(20) NOT NULL,
    Name VARCHAR(30) NOT NULL,
    Occupation VARCHAR(20),
    DateOfBirth DATE,
    PRIMARY KEY (SIN)
);

CREATE TABLE Host (
    SIN VARCHAR(20) NOT NULL,
    FOREIGN KEY (SIN) REFERENCES User(SIN) ON DELETE CASCADE
);

CREATE TABLE Renter (
    SIN VARCHAR(20) NOT NULL,
    CreditCardNumber CHAR(16),
    FOREIGN KEY (SIN) REFERENCES User(SIN) ON DELETE CASCADE
);
 
CREATE TABLE LocatedAt (
    ListingID CHAR(20) NOT NULL,
    Country VARCHAR(20) NOT NULL,
    PostalCode VARCHAR(10) NOT NULL,
    FOREIGN KEY (ListingID) REFERENCES Listing(ListingID) ON DELETE CASCADE,
    FOREIGN KEY (Country, PostalCode)
REFERENCES Address(Country, PostalCode)
);


CREATE TABLE ResidesAt (
    SIN VARCHAR(20) NOT NULL,
    Country VARCHAR(20) NOT NULL,
    PostalCode VARCHAR(20) NOT NULL,
    FOREIGN KEY (SIN) REFERENCES User(SIN) ON DELETE CASCADE,
    FOREIGN KEY (Country, PostalCode) REFERENCES Address(Country, PostalCode)
);

CREATE TABLE HostedBy (
    ListingID Char(20) NOT NULL,
    SIN VARCHAR(20) NOT NULL,
    FOREIGN KEY (ListingID) REFERENCES Listing(ListingID) ON DELETE CASCADE,
    FOREIGN KEY (SIN) REFERENCES Host(SIN) ON DELETE CASCADE
);

CREATE TABLE Booking (
    ListingID CHAR(20) NOT NULL,
    StartDate DATETIME NOT NULL,
    EndDate DATETIME NOT NULL,
    SIN VARCHAR(20) NOT NULL,
    Cancelled BIT(1) DEFAULT 0,
    FOREIGN KEY (ListingID, StartDate, EndDate) REFERENCES Availability(ListingID, StartDate, EndDate) ON DELETE CASCADE,
    FOREIGN KEY (SIN) REFERENCES Renter(SIN) ON DELETE CASCADE
);


CREATE TABLE ListingReview (
    ListingID CHAR(20) NOT NULL,
    SIN VARCHAR(20) NOT NULL,
    Comment VARCHAR(250),
    Rating INT NOT NULL,
    FOREIGN KEY (ListingID) REFERENCES Listing(ListingID) ON DELETE CASCADE,
    FOREIGN KEY (SIN) REFERENCES Renter(SIN)
);


CREATE TABLE HostReview (
    HostSIN VARCHAR(20) NOT NULL,
    RenterSIN VARCHAR(20) NOT NULL,
    Comment VARCHAR(250),
    Rating INT NOT NULL,
    FOREIGN KEY (HostSIN) REFERENCES Host(SIN) ON DELETE CASCADE,
    FOREIGN KEY (RenterSIN) REFERENCES Renter(SIN)
);

CREATE TABLE RenterReview (
    HostSIN VARCHAR(20) NOT NULL,
    RenterSIN VARCHAR(20) NOT NULL,
    Comment VARCHAR(250),
    Rating INTEGER NOT NULL,
    FOREIGN KEY (RenterSIN) REFERENCES Renter(SIN) ON DELETE CASCADE,
    FOREIGN KEY (HostSIN) REFERENCES Host(SIN)
);

DELIMITER //
CREATE TRIGGER DeleteListingChecker BEFORE DELETE ON Listing
    FOR EACH ROW
    BEGIN
        IF EXISTS (
            SELECT
                *
            FROM
                Booking AS b
            WHERE
                b.ListingID = OLD.ListingID 
                AND b.Cancelled = 0
        )
        THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'REJECTED';
    END//
DELIMITER ;

DELIMITER //
CREATE TRIGGER InsertListingReviewChecker BEFORE INSERT ON ListingReview
    FOR EACH ROW
    BEGIN
        IF NOT EXISTS (
            SELECT
                *
            FROM
                Booking AS b
                INNER JOIN Availability AS a ON (
                    a.ListingID = b.ListingID
                    AND a.StartDate = b.StartDate
                    AND a.EndDate = b.EndDate
                )
            WHERE
                b.Cancelled = 0
                AND b.SIN = NEW.SIN
                AND b.ListingID = NEW.ListingID
                AND a.EndDate < CURRENT_TIMESTAMP
        ) THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'REJECTED';
        END IF;
    END//
DELIMITER ;
